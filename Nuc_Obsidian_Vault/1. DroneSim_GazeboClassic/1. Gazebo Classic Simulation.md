PX4 Gazebo Classic Documentation available [here](https://docs.px4.io/main/en/sim_gazebo_classic/index.html) 
# Installation
## 1. Install Ubuntu 22.04 
1. Install Ubuntu 22.04 as per obsidian
2. Install ROS2 Humble from [website](https://docs.ros.org/en/humble/Installation/Ubuntu-Install-Debians.html)
3. Add the following to the end of the `~/.bashrc` script:
```bash
source /opt/ros/humble/setup.bash
source /usr/share/colcon_argcomplete/hook/colcon-argcomplete.bash
export ROS_DOMAIN_ID=0
export ROS_LOCALHOST_ONLY=1
```

## 2. Install QGC:

1. Run Following in Terminal
```Shell
sudo usermod -a -G dialout $USER
sudo apt-get remove modemmanager -y
sudo apt install gstreamer1.0-plugins-bad gstreamer1.0-libav gstreamer1.0-gl -y
sudo apt install libfuse2 -y
sudo apt install libxcb-xinerama0 libxkbcommon-x11-0 libxcb-cursor-dev -y
```
2. Download [QGroundControl.AppImage](https://d176tv9ibo4jno.cloudfront.net/latest/QGroundControl.AppImage) and move downloaded file to "home" folder
3. Install QGC
```Shell
cd
chmod +x ./QGroundControl.AppImage
```
4. Too run QGC use:
```Shell
cd
./QGroundControl.AppImage
```

## 3. Install Gazebo Classic
1. Remove Gazebo Harmonic and install Gazebo-Classic 11 for Ubuntu 22.04 as per [this website](https://docs.px4.io/main/en/sim_gazebo_classic/) 
```Shell
sudo apt remove gz-harmonic
sudo apt install aptitude
sudo aptitude install gazebo libgazebo11 libgazebo-dev

sudo apt update
sudo apt install libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev

# Source the ROS2 setup (if needed) and then Gazebo’s setup.
# (Order can matter if ROS2 setup changes some environment variables.)
source /opt/ros/humble/setup.bash
source /usr/share/gazebo/setup.bash
```
1. Add the following to the .bashrc file
```Shell
source /opt/ros/humble/setup.bash
source /usr/share/gazebo/setup.bash
export GAZEBO_MODEL_PATH=/home/nico/PX4-Autopilot/Tools/simulation/gazebo-classic/sitl_gazebo-classic/models
```

2. If you get some errors with gazebo not loading properly, try following (Maybe take out the make stuff. Makes it take super long):
```Shell
# Override GAZEBO_MODEL_PATH to only include your PX4 models directory.
export GAZEBO_MODEL_PATH=/home/nico/PX4-Autopilot/Tools/simulation/gazebo-classic/sitl_gazebo-classic/models

# (Optionally, you can check the variables:)
echo "GAZEBO_RESOURCE_PATH: $GAZEBO_RESOURCE_PATH"
echo "GAZEBO_MODEL_PATH: $GAZEBO_MODEL_PATH"
echo "GAZEBO_PLUGIN_PATH: $GAZEBO_PLUGIN_PATH"

cd
cd PX4-Autopilot/
rm -rf build
make px4_sitl gazebo-classic_iris_opt_flow
```
3. NOTE: After closing the Simulation using ctrl+c, run the following command, to kill all gazebo instances, else multiple drones will stack on to of each other adn px4 will not get ready for takeoff
```Shell
pkill -f px4
pkill -f gzserver
pkill -f gzclient
```
4. Then launch again using:
```Shell
cd
cd PX4-Autopilot/
make px4_sitl gazebo-classic_iris_opt_flow
```


## 4. Run the Micro XRCE-DDS Agent

5. Install like in "2. DroneSim_GazeboSim"
6. Launch using:
```Shell
MicroXRCEAgent udp4 -p 8888
```



# 5. Create Offboard Control Node

7. Follow instructions in "3.1. PX4 Offboard Control mode Code"
8. After doing any changes to the code, do:
```Shell
cd ~/ros2_ws
colcon build --packages-select offboard_control_node
source ~/ros2_ws/install/setup.bash
```
1. Launch using:
```Shell
ros2 run offboard_control_node offboard_control_node
```



# 6. Visualization of Setpoint and actual position

1. Use Jaeyoung Lim's example. Even though the offboard control didnt work for me, the visualisation is quite useful. 
2. Find the insatllation process on [this website](https://github.com/Jaeyoung-Lim/px4-offboard/tree/master?tab=readme-ov-file) 
3. Build the package using:
```Shell
cd
cd ros2_ws/
colcon build --packages-select px4_offboard
```
1. Launch RVIZ visualization using:
```Shell
ros2 launch px4_offboard visualize.launch.py
```







# 99. Things to launch:

Gazebo with quad and Optical Flow
```Shell
cd
cd PX4-Autopilot/
make px4_sitl gazebo-classic_iris_opt_flow
```

QGC
```Shell
cd
./QGroundControl.AppImage
```

MicroDDS Agent
```Shell
MicroXRCEAgent udp4 -p 8888
```

Offboard Control Node
```Shell
ros2 run offboard_control_node offboard_control_node
```

OPTIONAL: if you want the RVIZ visualization:
```Shell
ros2 launch px4_offboard visualize.launch.py
```







